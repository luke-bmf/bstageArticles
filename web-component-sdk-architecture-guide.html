<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Component 기반 SDK 개발 및 아키텍처 가이드</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    html { overflow-x: hidden; }
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 880px;
      margin: 0 auto;
      padding: 2rem 80px;
      position: relative;
      line-height: 1.5;
    }
    h1, h2, h3, h4, h5, h6 { line-height: 1.2; }
    img { max-width: 100%; height: auto; }
    table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 14px;
      text-align: left;
      word-break: break-word;
      overflow-wrap: break-word;
      vertical-align: top;
    }
    th { background: #f5f5f5; font-weight: 600; }
    tr:nth-child(even) { background: #fafafa; }
    blockquote {
      color: #6b7280;
      border-left: 3px solid #9ca3af;
      padding-left: 16px;
      margin: 1rem 0;
    }
    blockquote p { margin: 0; }
    pre, code { max-width: 100%; overflow-x: auto; background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
    pre { padding: 16px; margin: 1rem 0; white-space: pre-wrap; }
    @media screen and (max-width: 500px) {
      body { padding: 1rem 16px; }
    }
  </style>
</head>
<body>
  <h1>b.stage를 위한 Web Component 기반 SDK 개발 및 아키텍처 가이드</h1>
  <blockquote>
    <p>b.stage 플랫폼에서 3rd-party 템플릿을 Web Component로 개발하기 위한 SDK입니다.</p>
  </blockquote>

  <h2>1. 왜 만들었나?</h2>
  <p>기존 Liquid 템플릿 시스템의 한계를 극복하기 위해 Web Component 기반 SDK로 전환했습니다.</p>

  <h2>2. Liquid vs SDK 비교</h2>
  <table>
    <thead>
      <tr>
        <th>구분</th>
        <th>Liquid (기존)</th>
        <th>SDK (현재)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>UI 프레임워크</strong></td>
        <td>없음 (Liquid + vanilla JS)</td>
        <td>React 지원 (Vue / Svelte 예정)</td>
      </tr>
      <tr>
        <td><strong>스타일 격리</strong></td>
        <td>없음</td>
        <td>Shadow DOM</td>
      </tr>
      <tr>
        <td><strong>API 호출</strong></td>
        <td>직접 fetch</td>
        <td>BstageClient (타입 안전, 토큰 은닉)</td>
      </tr>
      <tr>
        <td><strong>빌드</strong></td>
        <td>없음</td>
        <td>CLI로 IIFE 번들 + 매니페스트 자동 생성</td>
      </tr>
      <tr>
        <td><strong>플랫폼 연동</strong></td>
        <td>없음</td>
        <td>CustomEvent 기반 양방향 통신</td>
      </tr>
    </tbody>
  </table>

  <h2>3. 패키지 구조</h2>
  <pre><code>bstage-sdk/
├── packages/
│   ├── core/     @partners-bmf/bstage-core    핵심 런타임
│   ├── react/    @partners-bmf/bstage-react   React 바인딩
│   ├── host/     @partners-bmf/bstage-host    플랫폼(bstage) 런타임
│   └── cli/      @partners-bmf/bstage-cli     빌드 CLI</code></pre>

  <h2>4. 의존 관계</h2>
  <pre><code>react ──→ core
host  ──→ core
cli   (독립)</code></pre>

  <h2>5. 아키텍처</h2>
  <p>b.stage 플랫폼(Host)이 <code>loadTemplate(manifestUrl)</code>로 템플릿을 로드하고, <code>TemplateHandle</code>을 통해 마운트·업데이트·이벤트 수신·언마운트를 수행합니다. CustomEvent(bstage:*)를 통해 Web Component(Shadow DOM)와 양방향 통신합니다.</p>

  <h2>6. 핵심 설계 결정</h2>
  <h3>Web Component + Shadow DOM</h3>
  <ul>
    <li>웹 표준 기술이라 별도 런타임 없이 모든 브라우저에서 동작합니다.</li>
    <li>Shadow DOM이 스타일을 격리하여 플랫폼 CSS와 충돌하지 않습니다.</li>
    <li>iframe과 달리 성능 오버헤드가 없고, bstage와 동일 컨텍스트에서 실행됩니다.</li>
  </ul>
  <h3>PlatformBridge (양방향 이벤트)</h3>
  <ul>
    <li>CustomEvent 기반으로 bstage-템플릿 간 느슨한 결합을 유지합니다.</li>
    <li>양쪽이 서로의 내부 구현을 몰라도 이벤트만으로 통신할 수 있습니다.</li>
  </ul>
  <h3>FrameworkAdapter 패턴</h3>
  <ul>
    <li>core가 특정 프레임워크에 의존하지 않아 React/Vue/Svelte를 동일한 구조로 지원합니다.</li>
    <li>새로운 프레임워크 추가 시 어댑터만 구현하면 됩니다.</li>
  </ul>
  <h3>IIFE 번들</h3>
  <ul>
    <li><code>&lt;script&gt;</code> 태그 하나로 로딩되어 bstage 측 빌드 설정이 필요 없습니다.</li>
    <li>CSS와 프레임워크가 모두 번들에 포함되어 단일 파일로 배포됩니다.</li>
  </ul>

  <h2>7. 이벤트 시스템</h2>
  <h3>템플릿 → 플랫폼</h3>
  <table>
    <thead>
      <tr>
        <th>이벤트</th>
        <th>payload</th>
        <th>설명</th>
      </tr>
    </thead>
    <tbody>
      <tr><td><code>navigate</code></td><td>{ path, params? }</td><td>앱 내 페이지 이동</td></tr>
      <tr><td><code>go-back</code></td><td>{}</td><td>뒤로가기</td></tr>
      <tr><td><code>open-external</code></td><td>{ url }</td><td>외부 URL 열기</td></tr>
      <tr><td><code>toast</code></td><td>{ message, duration?, variant? }</td><td>토스트 알림</td></tr>
      <tr><td><code>require-auth</code></td><td>{}</td><td>로그인 요청</td></tr>
      <tr><td><code>purchase</code></td><td>{ productId, metadata? }</td><td>구매 요청</td></tr>
    </tbody>
  </table>
  <h3>플랫폼 → 템플릿</h3>
  <table>
    <thead>
      <tr>
        <th>이벤트</th>
        <th>payload</th>
        <th>설명</th>
      </tr>
    </thead>
    <tbody>
      <tr><td><code>theme-change</code></td><td>{ theme, colors? }</td><td>테마 변경</td></tr>
      <tr><td><code>language-change</code></td><td>{ language }</td><td>언어 변경</td></tr>
      <tr><td><code>data-update</code></td><td>{ domain, data }</td><td>데이터 갱신</td></tr>
      <tr><td><code>auth-change</code></td><td>{ authenticated, userId? }</td><td>인증 상태 변경</td></tr>
    </tbody>
  </table>

  <h2>8. 사용법: 템플릿 개발</h2>
  <h3>1. 프로젝트 설정</h3>
  <pre><code># 패키지 설치
pnpm add @partners-bmf/bstage-core @partners-bmf/bstage-react

# .npmrc (GitHub Packages 인증 필요)
@partners-bmf:registry=https://npm.pkg.github.com
//npm.pkg.github.com/:_authToken=${COMMON_TOKEN}
//npm.pkg.github.com/:always-auth=true</code></pre>

  <h3>2. 템플릿 작성</h3>
  <p><code>createTemplate</code>이 자동으로 <code>&lt;myvendor-myspace-home&gt;</code> 커스텀 엘리먼트를 등록합니다.</p>
  <pre><code>// src/templates/home/template.tsx
import { createTemplate } from "@partners-bmf/bstage-react";

function HomeTemplate() {
  return &lt;div&gt;Hello, b.stage!&lt;/div&gt;;
}

createTemplate(HomeTemplate, {
  vendor: "myvendor",
  space: "myspace",
  name: "home",
});</code></pre>

  <h3>3. 옵션</h3>
  <pre><code>createTemplate(Component, {
  vendor: "myvendor",   // 필수
  space: "myspace",     // 필수
  name: "home",         // 필수
  target: "user",       // 'user' | 'admin' (기본: 'user')
  type: "landing",      // 자유 형식
  shadow: true,        // Shadow DOM 사용 여부 (기본: true)
  client: new BstageClient({...}),  // API 클라이언트 (선택)
  dataContract: {      // 필요한 데이터 선언 (선택)
    requires: ["lounge", "feed"],
    version: "1.0",
  },
});</code></pre>

  <h3>4. Hooks 사용</h3>
  <pre><code>import { useNavigation, useBstageClient, useBstageContext } from "@partners-bmf/bstage-react";

function MyComponent() {
  // 네비게이션
  const { navigate, goBack, openExternal } = useNavigation();

  // API 클라이언트 (createTemplate에서 client를 전달해야 사용 가능)
  const client = useBstageClient();

  // 브릿지 직접 접근
  const { bridge } = useBstageContext();

  useEffect(() => {
    client.get("/api/v1/lounges").then((res) => { ... });

    const off = bridge.on("theme-change", ({ theme }) => { ... });
    return () => off();
  }, []);

  return (
    &lt;button onClick={() => navigate("/lounge/123")}&gt;이동&lt;/button&gt;
  );
}</code></pre>

  <h3>5. BstageClient (API 호출)</h3>
  <pre><code>import { BstageClient } from "@partners-bmf/bstage-core";

const client = new BstageClient({
  appId: "bsa_xxxxx",
  appSecret: "bsp_xxxxx",
  tenantId: "myorg",
  phase: "dev",  // 'dev' | 'qa' | 'real'
});

// 타입 안전한 API 호출
const lounges = await client.get("/api/v2/home/lounge-list");

// 경로 파라미터
const content = await client.get("/api/v2/contents/{contentId}", {
  path: { contentId: "abc123" },
});

// 쿼리 파라미터
const list = await client.get("/api/v2/home/lounge-list", {
  query: { page: 1, size: 10 },
});</code></pre>
  <p>요청 헤더에 <code>X-BSTAGE-APP-ID</code>, <code>X-BSTAGE-APP-SECRET</code>, <code>X-BSTAGE-TENANT-ID</code>가 자동으로 포함됩니다. 3rd-party에 토큰이 직접 노출되지 않습니다.</p>
  <table>
    <thead>
      <tr>
        <th>Phase</th>
        <th>URL</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>dev</td><td>https://gateway-public.dev.bstage.systems</td></tr>
      <tr><td>qa</td><td>https://gateway-public.qa.bstage.systems</td></tr>
      <tr><td>real</td><td>https://gateway-public.bstage.systems</td></tr>
    </tbody>
  </table>

  <h3>6. 빌드</h3>
  <p>프로젝트 내 모든 <code>template.tsx</code> 파일을 자동 탐색하여 각각 빌드합니다.</p>
  <pre><code>npx bstage build</code></pre>
  <pre><code>dist/
└── user/
    └── myspace/
        ├── home/
        │   ├── template.js      # IIFE 번들
        │   └── manifest.json    # 메타데이터
        └── ranking/
            ├── template.js
            └── manifest.json</code></pre>
  <p>Vite 프리셋 (<code>vite.config.ts</code>에서 dev 서버 및 커스텀 빌드 설정 시 사용):</p>
  <pre><code>import { createViteConfig } from "@partners-bmf/bstage-cli/vite";

export default createViteConfig({
  entry: "src/templates/home/template.tsx",
});</code></pre>

  <h2>9. 사용법: 플랫폼(bstage) 통합</h2>
  <h3>1. 템플릿 로드 및 마운트</h3>
  <pre><code>import { loadTemplate } from "@partners-bmf/bstage-host";

// CDN에서 매니페스트 로드 → 스크립트 로드 → TemplateHandle 반환
const handle = await loadTemplate(
  "https://cdn.example.com/templates/myvendor/user/myspace/home/manifest.json"
);

// 컨테이너에 마운트
const container = document.getElementById("template-root");
handle.mount(container, {
  userId: "user-123",
  theme: "dark",
});</code></pre>

  <h3>2. 데이터 업데이트</h3>
  <pre><code>handle.update({
  userId: "user-123",
  theme: "light",  // 변경
});</code></pre>

  <h3>3. 이벤트 수신 (템플릿 → 플랫폼)</h3>
  <pre><code>// mount 전에 등록해도 됩니다 (버퍼링됨)
const unsubscribe = handle.on("navigate", ({ path, params }) => {
  router.push(path, params);
});

handle.on("toast", ({ message, variant }) => {
  showToast(message, variant);
});

// 구독 해제
unsubscribe();</code></pre>

  <h3>4. 이벤트 발신 (플랫폼 → 템플릿)</h3>
  <pre><code>handle.dispatch("theme-change", { theme: "dark" });
handle.dispatch("auth-change", { authenticated: true, userId: "user-123" });</code></pre>

  <h3>5. 언마운트</h3>
  <pre><code>handle.unmount();  // DOM에서 제거, 리스너 정리 (여러 번 호출해도 안전)</code></pre>

  <h2>10. 빌드 &amp; 배포</h2>
  <h3>SDK 패키지 배포</h3>
  <p>GitHub Packages에 퍼블리시합니다. <code>v*</code> 태그 push 시 자동으로 배포됩니다.</p>
  <pre><code># 버전 올린 후
git tag v0.2.0
git push origin v0.2.0
# → GitHub Actions가 4개 패키지를 자동 퍼블리시</code></pre>

  <h3>템플릿 프로젝트 배포</h3>
  <p><code>main</code> push 또는 태그 push 시 reusable workflow가 실행됩니다.</p>
  <ol>
    <li>SDK 감지 → <code>pnpm install</code> → <code>pnpm build</code></li>
    <li><code>dist/</code> + <code>public/</code> 결과물을 S3에 업로드</li>
    <li>CDN을 통해 서빙</li>
  </ol>

  <h2>11. manifest.json 스펙</h2>
  <p>b.stage는 이 매니페스트를 읽어서 커스텀 엘리먼트 태그명, 스크립트 URL, 필요 데이터 등을 파악합니다.</p>
  <pre><code>{
  "name": "home",
  "vendor": "myvendor",
  "space": "myspace",
  "target": "user",
  "version": "0.1.0",
  "element": "myvendor-myspace-home",
  "entry": "template.js",
  "integration": "web-component",
  "sdkVersion": "0.1.0",
  "framework": "react",
  "type": "landing",
  "dataContract": {
    "requires": ["lounge", "feed"],
    "version": "1.0"
  },
  "bundleSize": 245760,
  "builtAt": "2025-06-15T12:00:00.000Z"
}</code></pre>
</body>
</html>
